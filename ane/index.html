<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>ç¾½èœå°‚ç”¨ ã‚«ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚«ãƒ¼</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f6b3c1">

<!-- iPhone -->
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body{
  margin:0;
  font-family:"Hiragino Maru Gothic ProN",sans-serif;
  background:#fff6ec;
  transition:background .5s;
}

.app{
  max-width:420px;
  margin:auto;
  padding:16px;
}

.header{
  text-align:center;
}

.header h1{
  margin:6px 0;
  color:#d86c8f;
}

.header p{
  margin:0;
  font-size:14px;
  color:#888;
}

.card{
  background:#fff;
  border-radius:22px;
  padding:16px;
  margin-top:18px;
  box-shadow:0 8px 20px rgba(0,0,0,.1);
}

input{ width:100%; }

canvas{
  width:80%;
  display:block;
  margin:12px auto 0;
  border-radius:18px;
}

.result{
  text-align:center;
}

.gage{
  height:18px;
  background:#eee;
  border-radius:10px;
  overflow:hidden;
  margin-top:10px;
}

.gage div{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#ff8a80,#f06292);
  transition:width .5s;
}

.percent{
  margin-top:6px;
  color:#d86c8f;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <h1>ã‚«ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
    <p>ğŸ‚ Happy Birthday ç¾½èœ ğŸ</p>
  </div>

  <div class="card">
    <input type="file" accept="image/*" id="file">
    <canvas id="cv"></canvas>
  </div>

  <div class="card result" id="result" style="display:none">
    <div id="text"></div>
    <div class="gage"><div id="bar"></div></div>
    <div class="percent" id="percent"></div>
  </div>

</div>

<script>
/* ===== ã‚³ãƒ”ãƒƒã‚¯è‰² ===== */
const copics={
  E00:[255,230,200], R000:[255,220,220], RV21:[255,190,200],
  R35:[200,50,70], E93:[120,60,40], YR31:[255,200,120],
  Y02:[255,240,120], B02:[60,150,220], E31:[200,170,140],
  BV31:[190,170,220], BG23:[80,200,190], V15:[160,60,160],
  B000:[220,240,255], R02:[255,140,140], E29:[90,50,30],
  G05:[90,180,90], YG67:[90,140,60], E35:[140,90,60],
  RV06:[180,60,100],
  "0":[255,255,255] // ã‚«ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒ–ãƒ¬ãƒ³ãƒ€ãƒ¼
};

const ratios=[
  {a:1,b:0},
  {a:0.7,b:0.3},
  {a:0.6,b:0.4}
];

const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");

/* ===== ç”»åƒèª­ã¿è¾¼ã¿ ===== */
document.getElementById("file").onchange=e=>{
  const img=new Image();
  img.onload=()=>{
    cv.width=img.width;
    cv.height=img.height;
    ctx.drawImage(img,0,0);
  };
  img.src=URL.createObjectURL(e.target.files[0]);
};

/* ===== è‰²å–å¾— ===== */
cv.onclick=e=>{
  const r=cv.getBoundingClientRect();
  const x=(e.clientX-r.left)*(cv.width/r.width);
  const y=(e.clientY-r.top)*(cv.height/r.height);
  const d=ctx.getImageData(x,y,1,1).data;

  document.body.style.background=`rgb(${d[0]},${d[1]},${d[2]})`;
  judge([d[0],d[1],d[2]]);
};

function dist(a,b){
  return Math.sqrt((a[0]-b[0])**2+(a[1]-b[1])**2+(a[2]-b[2])**2);
}

function mix(a,b,ra,rb){
  if(b==="0"){
    return [
      a[0]+(255-a[0])*rb,
      a[1]+(255-a[1])*rb,
      a[2]+(255-a[2])*rb
    ];
  }
  return [
    a[0]*ra+b[0]*rb,
    a[1]*ra+b[1]*rb,
    a[2]*ra+b[2]*rb
  ];
}

/* ===== åˆ¤å®š ===== */
function judge(t){
  let best={d:9999};
  const keys=Object.keys(copics).filter(c=>c!=="0");

  // å˜è‰²
  keys.forEach(c=>{
    const d=dist(t,copics[c]);
    if(d<best.d) best={type:"å˜è‰²",d,c};
  });

  // æ··è‰²ãƒ»è–„ã‚
  for(let i=0;i<keys.length;i++){
    for(let j=i+1;j<keys.length;j++){
      ratios.forEach(r=>{
        let m=mix(copics[keys[i]],copics[keys[j]],r.a,r.b);
        let d=dist(t,m);
        if(d<best.d){
          best={
            type:"æ··è‰²",
            d,
            c1:keys[i],
            c2:keys[j],
            r1:r.a*10,
            r2:r.b*10
          };
        }

        m=mix(copics[keys[i]],"0",r.a,r.b);
        d=dist(t,m);
        if(d<best.d){
          best={
            type:"è–„ã‚",
            d,
            c1:keys[i],
            r1:r.a*10,
            r2:r.b*10
          };
        }
      });
    }
  }

  const p=Math.max(0,Math.round(100-best.d/4));
  let html="";

  if(best.type==="å˜è‰²"){
    html=`ğŸ–Œ å˜è‰²ãŒä¸€ç•ªè¿‘ã„<br><b>${best.c}</b>`;
  }else if(best.type==="è–„ã‚"){
    html=`ğŸ–Œ è–„ã‚ãŸæ–¹ãŒè¿‘ã„<br>
      å…ˆã« <b>${best.c1}</b>ï¼ˆ${best.r1}ï¼‰<br>
      ã‚ã¨ã§ <b>0</b>ï¼ˆ${best.r2}ï¼‰`;
  }else{
    html=`ğŸ–Œ æ··è‰²ã—ãŸæ–¹ãŒè¿‘ã„<br>
      å…ˆã« <b>${best.c1}</b>ï¼ˆ${best.r1}ï¼‰<br>
      ã‚ã¨ã§ <b>${best.c2}</b>ï¼ˆ${best.r2}ï¼‰`;
  }

  document.getElementById("result").style.display="block";
  document.getElementById("text").innerHTML=html;
  document.getElementById("bar").style.width=p+"%";
  document.getElementById("percent").textContent=`ä¼¼ã¦ã‚‹åº¦ ${p}%`;
}
</script>

</body>
</html>
